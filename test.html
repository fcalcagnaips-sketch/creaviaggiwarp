<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Test API Amadeus</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        .result {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 8px 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { border-left-color: #38a169; }
        .error { border-left-color: #e53e3e; color: #c53030; }
        .loading { border-left-color: #3182ce; color: #2b6cb0; font-style: italic; }
        input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            margin: 5px;
            font-size: 14px;
        }
        .test-section {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .test-section:last-child {
            border-bottom: none;
        }
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 13px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .status.hidden { opacity: 0; transform: translateX(100%); }
        .status.success { border-left: 4px solid #38a169; color: #38a169; }
        .status.error { border-left: 4px solid #e53e3e; color: #e53e3e; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test API Amadeus - XAMPP</h1>
    
    <div class="card">
        <div class="test-section">
            <h3>1ï¸âƒ£ Test Connessione API</h3>
            <button onclick="testConnection()">ğŸ”— Testa Connessione</button>
            <div id="connectionResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2ï¸âƒ£ Test Ricerca Aeroporti</h3>
            <input type="text" id="searchKeyword" placeholder="Es: Roma, Milano, Londra" style="width: 200px;">
            <button onclick="searchAirports()">ğŸ” Cerca Aeroporti</button>
            <button onclick="testQuickSearch('Roma')">ğŸ›ï¸ Roma</button>
            <button onclick="testQuickSearch('Milano')">ğŸ¢ Milano</button>
            <button onclick="testQuickSearch('Londra')">ğŸ¡ Londra</button>
            <button onclick="testQuickSearch('Parigi')">ğŸ‡«ğŸ‡· Parigi</button>
            <div id="airportResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3ï¸âƒ£ Test Ricerca Voli</h3>
            <div style="margin-bottom: 10px;">
                <input type="text" id="origin" placeholder="FCO" style="width: 80px;">
                <span>â†’</span>
                <input type="text" id="destination" placeholder="LHR" style="width: 80px;">
                <input type="date" id="flightDate" style="width: 140px;">
                <input type="number" id="adults" value="1" min="1" max="9" style="width: 60px;" placeholder="Adulti">
            </div>
            <button onclick="searchFlights()">âœˆï¸ Cerca Voli</button>
            <button onclick="quickFlightSearch('FCO', 'LHR')">ğŸ‡¬ğŸ‡§ FCOâ†’LHR</button>
            <button onclick="quickFlightSearch('FCO', 'MAD')">ğŸ‡ªğŸ‡¸ FCOâ†’MAD</button>
            <button onclick="quickFlightSearch('MXP', 'CDG')">ğŸ‡«ğŸ‡· MXPâ†’CDG</button>
            <div id="flightResult" class="result"></div>
        </div>
    </div>

    <!-- Status indicator -->
    <div id="status" class="status hidden">
        <span id="statusText"></span>
    </div>

    <script src="js/amadeus-api.js"></script>
    <script>
        // Imposta data di domani come default
        document.getElementById('flightDate').value = new Date(Date.now() + 86400000).toISOString().split('T')[0];
        
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            const text = document.getElementById('statusText');
            text.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 4000);
        }
        
        function showResult(elementId, content, type = '') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
        }
        
        async function testConnection() {
            showResult('connectionResult', 'Test connessione in corso...', 'loading');
            try {
                console.log('ğŸ”„ Test connessione API Amadeus...');
                const isConnected = await window.amadeusAPI.checkConnection();
                if (isConnected) {
                    showResult('connectionResult', 'âœ… Connessione API Amadeus riuscita!\nToken ottenuto correttamente.', 'success');
                    showStatus('API connesso!');
                } else {
                    showResult('connectionResult', 'âŒ Connessione API fallita', 'error');
                    showStatus('Errore connessione', 'error');
                }
            } catch (error) {
                showResult('connectionResult', `âŒ Errore: ${error.message}`, 'error');
                showStatus('Errore API', 'error');
                console.error('Errore connessione:', error);
            }
        }
        
        async function searchAirports() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            if (!keyword) {
                showStatus('Inserisci una parola chiave', 'error');
                return;
            }
            await testQuickSearch(keyword);
        }
        
        async function testQuickSearch(keyword) {
            showResult('airportResult', `Ricerca aeroporti per "${keyword}"...`, 'loading');
            try {
                console.log(`ğŸ” Ricerca aeroporti: ${keyword}`);
                const airports = await window.amadeusAPI.searchAirports(keyword, 6);
                
                if (airports.length === 0) {
                    showResult('airportResult', `âŒ Nessun aeroporto trovato per "${keyword}"`, 'error');
                    return;
                }
                
                const results = airports.map((airport, index) => 
                    `${index + 1}. ${airport.name} (${airport.iataCode})\n   ğŸ“ ${airport.city}, ${airport.country}`
                ).join('\n\n');
                
                showResult('airportResult', `âœ… Trovati ${airports.length} aeroporti:\n\n${results}`, 'success');
                showStatus(`${airports.length} aeroporti trovati`);
            } catch (error) {
                showResult('airportResult', `âŒ Errore ricerca: ${error.message}`, 'error');
                showStatus('Errore ricerca aeroporti', 'error');
                console.error('Errore ricerca aeroporti:', error);
            }
        }
        
        async function searchFlights() {
            const origin = document.getElementById('origin').value.trim().toUpperCase();
            const destination = document.getElementById('destination').value.trim().toUpperCase();
            const date = document.getElementById('flightDate').value;
            const adults = parseInt(document.getElementById('adults').value);
            
            if (!origin || !destination || !date || !adults) {
                showStatus('Compila tutti i campi volo', 'error');
                return;
            }
            
            await quickFlightSearch(origin, destination, date, adults);
        }
        
        async function quickFlightSearch(origin, destination, date = null, adults = 1) {
            if (!date) date = document.getElementById('flightDate').value;
            
            showResult('flightResult', `Ricerca voli ${origin} â†’ ${destination}...`, 'loading');
            try {
                console.log(`âœˆï¸ Ricerca voli: ${origin} â†’ ${destination}`);
                const flights = await window.amadeusAPI.searchFlights({
                    origin,
                    destination,
                    departureDate: date,
                    adults,
                    max: 8
                });
                
                if (flights.length === 0) {
                    showResult('flightResult', `âŒ Nessun volo trovato per ${origin} â†’ ${destination}\nProva con date diverse o altre destinazioni.`, 'error');
                    return;
                }
                
                const results = flights.map((flight, index) => {
                    const outbound = flight.outbound;
                    const firstSeg = outbound.segments[0];
                    const lastSeg = outbound.segments[outbound.segments.length - 1];
                    
                    return `${index + 1}. ğŸ’° ${flight.price.formatted}
   ğŸ›« ${firstSeg.departure.iataCode} ${firstSeg.departure.timeFormatted} â†’ ${lastSeg.arrival.iataCode} ${lastSeg.arrival.timeFormatted}
   â±ï¸ ${window.amadeusAPI.formatDuration(outbound.duration)} | ${outbound.totalStops > 0 ? `${outbound.totalStops} scalo${outbound.totalStops > 1 ? 'i' : ''}` : 'Diretto'}
   âœˆï¸ ${flight.validatingAirlineCodes.join(', ')} | ğŸª‘ ${flight.numberOfBookableSeats} posti`;
                }).join('\n\n');
                
                showResult('flightResult', `âœ… Trovati ${flights.length} voli:\n\n${results}`, 'success');
                showStatus(`${flights.length} voli trovati`);
                
                // Aggiorna i campi del form per facilitÃ 
                document.getElementById('origin').value = origin;
                document.getElementById('destination').value = destination;
                
            } catch (error) {
                showResult('flightResult', `âŒ Errore ricerca voli: ${error.message}`, 'error');
                showStatus('Errore ricerca voli', 'error');
                console.error('Errore ricerca voli:', error);
            }
        }
        
        // Test automatico all'avvio
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('ğŸš€ Avvio test automatico...');
                testConnection();
            }, 500);
        });
    </script>
</body>
</html>
